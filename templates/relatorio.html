{% extends 'base.html' %}

{% block title %}Relatório de Limpeza{% endblock %}

{% block style %}
.container {
    max-width: 98% !important;
}
.card {
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
.table-container {
    overflow-x: auto;
    max-height: 75vh;
    overflow-y: auto;
}
.table {
    font-size: 0.95rem;
    margin-bottom: 0;
    border-collapse: collapse;
}
.table th {
    background-color: #495057;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    white-space: nowrap;
    font-size: 0.9rem;
    padding: 12px;
    border: 1px solid #6c757d !important;
}
.table td {
    padding: 12px 8px;
    vertical-align: middle;
    border: 1px solid #dee2e6 !important;
}
.table tbody tr {
    border-bottom: 2px solid #e9ecef;
}
.table tbody tr:hover {
    background-color: #f8f9fa;
}
.btn-delete {
    padding: 4px 8px;
    font-size: 0.8rem;
}
.obs-cell {
    max-width: 200px;
    width: 200px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
}
.obs-cell:hover {
    background-color: #fff3cd !important;
}
.badge-terminal {
    background-color: #ffc107;
    color: #000;
}
.badge-concorrente {
    background-color: #17a2b8;
    color: #fff;
}
.filter-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.btn-info-icon {
    padding: 4px 8px;
    font-size: 0.8rem;
}
.badge-s { background-color: #28a745; color: white; }
.badge-n { background-color: #dc3545; color: white; }
.badge-na { background-color: #6c757d; color: white; }
select.form-select-sm {
    font-size: 0.85rem;
    padding: 2px 5px;
}

.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    min-height: 100vh;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    overflow: hidden;
}

.modal-overlay.show {
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-overlay .modal-content {
    background-color: #fff;
    width: 100%;
    height: 100%;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.modal-overlay .modal-header {
    padding: 25px 30px;
    border-bottom: 2px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f8f9fa;
    flex: 0 0 auto;
}

.modal-overlay .modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 24px;
    font-weight: 600;
}

.modal-overlay .btn-close-modal {
    background: none;
    border: none;
    font-size: 40px;
    cursor: pointer;
    color: #999;
    line-height: 1;
    padding: 0;
    width: 40px;
    height: 40px;
}

.modal-overlay .btn-close-modal:hover {
    color: #333;
}

.modal-overlay .modal-body {
    padding: 0;
    flex: 1 1 auto;
    overflow-y: auto;
    overflow-x: hidden;
    background-color: #fff;
    min-height: 0;
    -webkit-overflow-scrolling: touch;
}

.modal-overlay .modal-footer {
    padding: 25px 30px;
    border-top: 2px solid #dee2e6;
    background-color: #f8f9fa;
    flex: 0 0 auto;
}

.modal-overlay .item-limpeza {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid #e9ecef;
    background-color: #fff;
    transition: all 0.3s ease;
    position: relative;
}

.modal-overlay .item-limpeza:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.modal-overlay .item-limpeza:last-child {
    border-bottom: none;
}

.modal-overlay .item-label {
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
    font-size: 18px;
    flex: 1;
}

.modal-overlay .item-opcoes {
    display: flex;
    gap: 25px;
}

.modal-overlay .radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 600;
    margin: 0;
    font-size: 16px;
    padding: 8px 16px;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.modal-overlay .radio-label:hover {
    background-color: #f1f3f5;
}

.modal-overlay .radio-label input[type="radio"] {
    width: 22px;
    height: 22px;
    cursor: pointer;
}

.modal-overlay .radio-label input[type="radio"]:checked {
    accent-color: #28a745;
}

.modal-overlay .item-limpeza.erro {
    background-color: #fff3cd;
    border-left: 5px solid #ffc107;
    animation: shake 0.5s;
}

.modal-overlay .item-limpeza.completo {
    background-color: #d4edda;
    border-left: 5px solid #28a745;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'salas_view' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="filter-section">
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label"><i class="fas fa-search"></i> Pesquisar</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Sala, setor, colaborador...">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label"><i class="fas fa-building"></i> Setor</label>
                <select id="setorFilter" class="form-select">
                    <option value="">Todos</option>
                    {% for setor in setores %}
                    <option value="{{ setor }}">{{ setor }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label"><i class="fas fa-broom"></i> Tipo</label>
                <select id="tipoFilter" class="form-select">
                    <option value="">Todos</option>
                    <option value="terminal">Terminal</option>
                    <option value="concorrente">Concorrente</option>
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label"><i class="fas fa-sort"></i> Ordenar por</label>
                <select id="sortBy" class="form-select">
                    <option value="data_desc">Data (Mais recente)</option>
                    <option value="data_asc">Data (Mais antiga)</option>
                    <option value="sala_asc">Sala (A-Z)</option>
                    <option value="sala_desc">Sala (Z-A)</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label"><i class="fas fa-calendar"></i> Data Início</label>
                <input type="date" id="dataInicio" class="form-control">
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label"><i class="fas fa-calendar"></i> Data Fim</label>
                <input type="date" id="dataFim" class="form-control">
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <span id="resultCount" class="text-muted">Total: {{ registros|length }} registros</span>
            <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-redo"></i> Limpar Filtros
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-bordered table-hover table-sm">
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th style="width: 120px;">Setor</th>
                    <th style="width: 200px;">Sala</th>
                    <th style="width: 150px;">Colaborador</th>
                    <th style="width: 110px;">Data</th>
                    <th style="width: 80px;">Hora</th>
                    <th style="width: 100px;">Tipo</th>
                    <th style="width: 120px;">Criticidade</th>
                    <th style="min-width: 150px;">Observações</th>
                    <th style="width: 180px;">Ações</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for registro in registros %}
                <tr data-setor="{{ registro.nome_setor }}" data-tipo="{{ registro.tipo_limpeza }}" data-data="{{ registro.data_limpeza|date:'Y-m-d' }}" data-sala="{{ registro.nome_sala }}" data-registro-id="{{ registro.id_registro }}">
                    <td>{{ registro.id_registro }}</td>
                    <td>{{ registro.nome_setor }}</td>
                    <td><strong>{{ registro.nome_sala }}</strong></td>
                    <td>{{ registro.colaborador }}</td>
                    <td>{{ registro.data_limpeza|date:"d/m/Y" }}</td>
                    <td>{{ registro.hora_limpeza }}</td>
                    <td>
                        <span class="badge badge-{{ registro.tipo_limpeza }}">{{ registro.tipo_limpeza|upper }}</span>
                    </td>
                    <td>{% if registro.criticidade and registro.criticidade != 'NA' %}{{ registro.criticidade }}{% else %}-{% endif %}</td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ registro.obs }}">
                        {{ registro.obs|default:"-" }}
                    </td>
                    <td>
                        <div class="d-flex">
                            <button class="btn btn-info btn-sm" onclick="mostrarItensLimpeza({{ registro.id_registro }})">
                                <i class="fas fa-info-circle"></i> Info
                            </button>
                            <button class="btn btn-secondary btn-sm ms-1" onclick="abrirModalEdicao({{ registro.id_registro }})">
                                <i class="fas fa-pencil-alt"></i> Editar
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="10" class="text-center text-muted">Nenhum registro encontrado no último mês.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editar Registro #<span id="editRegistroId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Colaborador</label>
                        <input type="text" id="editColaborador" class="form-control">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Data</label>
                        <input type="date" id="editData" class="form-control">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Hora</label>
                        <input type="time" id="editHora" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de Limpeza</label>
                        <select id="editTipo" class="form-select">
                            <option value="1">Concorrente</option>
                            <option value="2">Terminal</option>
                        </select>
                    </div>
                </div>

                <div id="camposTerminalEdit" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Criticidade</label>
                            <select id="editCriticidade" class="form-select">
                                <option value="1">Crítico</option>
                                <option value="2">Semi-crítico</option>
                                <option value="3">Não crítico</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary w-100" id="btnAbrirModalEdicaoLimpeza" style="font-size: 16px; padding: 14px;">
                            <i class="fas fa-list-check"></i> Selecionar Itens de Limpeza
                            <span id="contadorItensEdicao" style="display: none; margin-left: 10px; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 700;"></span>
                        </button>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-success w-100" id="btnAbrirModalEdicaoReposicao" style="font-size: 16px; padding: 14px;">
                            <i class="fas fa-box"></i> REPOSIÇÃO
                            <span id="contadorReposicaoEdicao" style="display: none; margin-left: 10px; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 700;"></span>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Observações</label>
                    <textarea id="editObs" class="form-control" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="btnExcluirModal">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarEdit">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o registro <strong>#<span id="deleteId"></span></strong>?</p>
                <p class="text-muted mb-0">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itensLimpezaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info"></i> Itens do Registro #<span id="itensLimpezaRegistroId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="itensLimpezaBody">
                <!-- Content will be populated by javascript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalItensLimpezaEdicao" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Itens de Limpeza Terminal</h3>
            <button type="button" class="btn-close-modal" id="btnFecharModalLimpezaEdicao">&times;</button>
        </div>
        <div class="modal-body">
            <div class="item-limpeza">
                <label class="item-label">Portas</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_portas" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_portas" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Teto</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_teto" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_teto" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Paredes</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_paredes" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_paredes" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Janelas</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_janelas" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_janelas" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Piso</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_piso" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_piso" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Superfície/Mobiliário</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_superficie_mobiliario" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_superficie_mobiliario" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Dispenser</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_dispenser" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_dispenser" value="N"> NÃO
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success w-100" id="btnConfirmarModalLimpezaEdicao" style="font-size: 20px; padding: 18px;">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>

<div id="modalReposicaoEdicao" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Itens de Reposição</h3>
            <button type="button" class="btn-close-modal" id="btnFecharModalReposicaoEdicao">&times;</button>
        </div>
        <div class="modal-body">
            <div class="item-limpeza">
                <label class="item-label">Papel Higiênico</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_hig" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_hig" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Papel Toalha</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_toalha" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_toalha" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Álcool</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_alcool" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_alcool" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Sabonete</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_sabonete" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_sabonete" value="N"> NÃO
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success w-100" id="btnConfirmarModalReposicaoEdicao" style="font-size: 20px; padding: 18px;">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('searchInput');
    const setorFilter = document.getElementById('setorFilter');
    const tipoFilter = document.getElementById('tipoFilter');
    const sortBy = document.getElementById('sortBy');
    const dataInicio = document.getElementById('dataInicio');
    const dataFim = document.getElementById('dataFim');
    const clearFilters = document.getElementById('clearFilters');
    const tableBody = document.getElementById('tableBody');
    const resultCount = document.getElementById('resultCount');

    let allRows = Array.from(tableBody.querySelectorAll('tr'));

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('data_inicio')) {
        dataInicio.value = urlParams.get('data_inicio');
    } else {
        const hoje = new Date();
        const trintaDiasAtras = new Date(hoje);
        trintaDiasAtras.setDate(hoje.getDate() - 30);
        dataInicio.value = trintaDiasAtras.toISOString().split('T')[0];
    }
    if (urlParams.get('data_fim')) {
        dataFim.value = urlParams.get('data_fim');
    } else {
        const hoje = new Date();
        dataFim.value = hoje.toISOString().split('T')[0];
    }

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedSetor = setorFilter.value;
        const selectedTipo = tipoFilter.value;

        let visibleCount = 0;

        allRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const setor = row.dataset.setor;
            const tipo = row.dataset.tipo;

            const matchSearch = text.includes(searchTerm);
            const matchSetor = !selectedSetor || setor === selectedSetor;
            const matchTipo = !selectedTipo || tipo === selectedTipo;

            if (matchSearch && matchSetor && matchTipo) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        resultCount.textContent = `Total: ${visibleCount} registros`;
    }

    function sortTable() {
        const sortValue = sortBy.value;

        allRows.sort((a, b) => {
            if (sortValue === 'data_desc') {
                return b.dataset.data.localeCompare(a.dataset.data);
            } else if (sortValue === 'data_asc') {
                return a.dataset.data.localeCompare(b.dataset.data);
            } else if (sortValue === 'sala_asc') {
                return a.dataset.sala.localeCompare(b.dataset.sala);
            } else if (sortValue === 'sala_desc') {
                return b.dataset.sala.localeCompare(a.dataset.sala);
            }
        });

        allRows.forEach(row => tableBody.appendChild(row));
        applyFilters();
    }

    searchInput.addEventListener('input', applyFilters);
    setorFilter.addEventListener('change', applyFilters);
    tipoFilter.addEventListener('change', applyFilters);
    dataInicio.addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        if (dataInicio.value) {
            params.set('data_inicio', dataInicio.value);
        } else {
            params.delete('data_inicio');
        }
        if (dataFim.value) {
            params.set('data_fim', dataFim.value);
        }
        window.location.search = params.toString();
    });
    dataFim.addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        if (dataFim.value) {
            params.set('data_fim', dataFim.value);
        } else {
            params.delete('data_fim');
        }
        if (dataInicio.value) {
            params.set('data_inicio', dataInicio.value);
        }
        window.location.search = params.toString();
    });
    sortBy.addEventListener('change', sortTable);

    clearFilters.addEventListener('click', () => {
        window.location.href = window.location.pathname;
    });

    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const itensLimpezaModal = new bootstrap.Modal(document.getElementById('itensLimpezaModal'));
    const modalItensLimpezaEdicao = document.getElementById('modalItensLimpezaEdicao');
    const modalReposicaoEdicao = document.getElementById('modalReposicaoEdicao');
    const itensLimpezaKeys = ['portas', 'teto', 'paredes', 'janelas', 'piso', 'superficie_mobiliario', 'dispenser'];
    const itensReposicaoKeys = ['papel_hig', 'papel_toalha', 'alcool', 'sabonete'];
    const modaisEdicao = {
        limpeza: modalItensLimpezaEdicao,
        reposicao: modalReposicaoEdicao
    };
    const itensPorTipo = {
        limpeza: itensLimpezaKeys,
        reposicao: itensReposicaoKeys
    };
    const contadoresEdicao = {
        limpeza: document.getElementById('contadorItensEdicao'),
        reposicao: document.getElementById('contadorReposicaoEdicao')
    };
    let currentEditId = null;
    let currentRegistroData = null;

    function limparMarcacoesModal(modal) {
        if (!modal) return;
        modal.querySelectorAll('.item-limpeza').forEach(item => item.classList.remove('erro', 'completo'));
    }

    function preencherModalEdicao(tipo) {
        if (!currentRegistroData) return;
        const modal = modaisEdicao[tipo];
        if (!modal) return;
        limparMarcacoesModal(modal);
        itensPorTipo[tipo].forEach(chave => {
            const valor = (currentRegistroData[chave] || '').toString().toUpperCase();
            const radios = modal.querySelectorAll(`input[name="modal_${chave}"]`);
            radios.forEach(radio => {
                radio.checked = radio.value === valor;
            });
            if ((valor === 'S' || valor === 'N') && radios.length) {
                const itemDiv = radios[0].closest('.item-limpeza');
                if (itemDiv) {
                    itemDiv.classList.add('completo');
                }
            }
        });
    }

    function abrirModalEdicaoItens(tipo) {
        const modal = modaisEdicao[tipo];
        if (!modal || !currentRegistroData) return;
        preencherModalEdicao(tipo);
        modal.classList.add('show');
    }

    function fecharModalEdicaoItens(tipo) {
        const modal = modaisEdicao[tipo];
        if (!modal) return;
        modal.classList.remove('show');
        limparMarcacoesModal(modal);
    }

    function atualizarContadorEdicao(tipo) {
        const contador = contadoresEdicao[tipo];
        if (!contador || !currentRegistroData) return;
        const itens = itensPorTipo[tipo];
        const preenchidos = itens.every(chave => {
            const valor = (currentRegistroData[chave] || '').toString().toUpperCase();
            return valor === 'S' || valor === 'N';
        });
        if (preenchidos) {
            contador.textContent = `${itens.length}/${itens.length}`;
            contador.style.display = 'inline';
        } else {
            contador.style.display = 'none';
        }
    }

    function confirmarModalEdicaoItens(tipo) {
        if (!currentRegistroData) return;
        const modal = modaisEdicao[tipo];
        if (!modal) return;
        const itens = itensPorTipo[tipo];
        let todosPreenchidos = true;

        itens.forEach(chave => {
            const radios = modal.querySelectorAll(`input[name="modal_${chave}"]`);
            const selecionado = modal.querySelector(`input[name="modal_${chave}"]:checked`);
            const itemDiv = radios.length ? radios[0].closest('.item-limpeza') : null;
            if (itemDiv) {
                itemDiv.classList.remove('erro', 'completo');
            }

            if (selecionado) {
                if (itemDiv) {
                    itemDiv.classList.add('completo');
                }
                currentRegistroData[chave] = selecionado.value;
            } else {
                todosPreenchidos = false;
                if (itemDiv) {
                    itemDiv.classList.add('erro');
                }
            }
        });

        if (!todosPreenchidos) {
            const primeiroErro = modal.querySelector('.item-limpeza.erro');
            if (primeiroErro) {
                primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        atualizarContadorEdicao(tipo);
        fecharModalEdicaoItens(tipo);
    }

    [modalItensLimpezaEdicao, modalReposicaoEdicao].forEach(modal => {
        if (!modal) return;
        modal.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const itemDiv = radio.closest('.item-limpeza');
                if (itemDiv) {
                    itemDiv.classList.remove('erro');
                    itemDiv.classList.add('completo');
                }
            });
        });
    });

    const btnAbrirModalEdicaoLimpeza = document.getElementById('btnAbrirModalEdicaoLimpeza');
    if (btnAbrirModalEdicaoLimpeza) {
        btnAbrirModalEdicaoLimpeza.addEventListener('click', () => abrirModalEdicaoItens('limpeza'));
    }
    const btnAbrirModalEdicaoReposicao = document.getElementById('btnAbrirModalEdicaoReposicao');
    if (btnAbrirModalEdicaoReposicao) {
        btnAbrirModalEdicaoReposicao.addEventListener('click', () => abrirModalEdicaoItens('reposicao'));
    }

    const btnFecharModalLimpezaEdicao = document.getElementById('btnFecharModalLimpezaEdicao');
    if (btnFecharModalLimpezaEdicao) {
        btnFecharModalLimpezaEdicao.addEventListener('click', () => fecharModalEdicaoItens('limpeza'));
    }
    const btnConfirmarModalLimpezaEdicao = document.getElementById('btnConfirmarModalLimpezaEdicao');
    if (btnConfirmarModalLimpezaEdicao) {
        btnConfirmarModalLimpezaEdicao.addEventListener('click', () => confirmarModalEdicaoItens('limpeza'));
    }

    const btnFecharModalReposicaoEdicao = document.getElementById('btnFecharModalReposicaoEdicao');
    if (btnFecharModalReposicaoEdicao) {
        btnFecharModalReposicaoEdicao.addEventListener('click', () => fecharModalEdicaoItens('reposicao'));
    }
    const btnConfirmarModalReposicaoEdicao = document.getElementById('btnConfirmarModalReposicaoEdicao');
    if (btnConfirmarModalReposicaoEdicao) {
        btnConfirmarModalReposicaoEdicao.addEventListener('click', () => confirmarModalEdicaoItens('reposicao'));
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            let handled = false;
            if (modalItensLimpezaEdicao && modalItensLimpezaEdicao.classList.contains('show')) {
                fecharModalEdicaoItens('limpeza');
                handled = true;
            }
            if (modalReposicaoEdicao && modalReposicaoEdicao.classList.contains('show')) {
                fecharModalEdicaoItens('reposicao');
                handled = true;
            }
            if (handled) {
                event.preventDefault();
                event.stopPropagation();
            }
        }
    });

    function atualizarContadoresEdicao() {
        atualizarContadorEdicao('limpeza');
        atualizarContadorEdicao('reposicao');
    }
    function mostrarItensLimpeza(id) {
        document.getElementById('itensLimpezaRegistroId').textContent = id;

        fetch(`/obter-registro/${id}/`)
            .then(response => response.json())
            .then(data => {
                const body = document.getElementById('itensLimpezaBody');
                const itensLimpeza = [
                    { label: 'Portas', value: data.portas },
                    { label: 'Teto', value: data.teto },
                    { label: 'Paredes', value: data.paredes },
                    { label: 'Janelas', value: data.janelas },
                    { label: 'Piso', value: data.piso },
                    { label: 'Superfície/Mobiliário', value: data.superficie_mobiliario },
                    { label: 'Dispenser', value: data.dispenser }
                ];
                const itensReposicao = [
                    { label: 'Papel Higienico', value: data.papel_hig },
                    { label: 'Papel Toalha', value: data.papel_toalha },
                    { label: 'Alcool', value: data.alcool },
                    { label: 'Sabonete', value: data.sabonete }
                ];

                const filtrarSim = item => (item.value || '').toString().toUpperCase() === 'S';
                const limpezaSim = itensLimpeza.filter(filtrarSim);
                const reposicaoSim = itensReposicao.filter(filtrarSim);

                if (!limpezaSim.length && !reposicaoSim.length) {
                    body.innerHTML = '<p class="text-muted mb-0">Nenhum item </p>';
                } else {
                    let content = '';

                    if (limpezaSim.length) {
                        content += '<h6 class="fw-bold">Itens de Limpeza</h6><ul class="list-group mb-3">';
                        limpezaSim.forEach(item => {
                            content += `<li class="list-group-item d-flex justify-content-between align-items-center">${item.label}<span class="badge bg-success rounded-pill">S</span></li>`;
                        });
                        content += '</ul>';
                    }

                    if (reposicaoSim.length) {
                        content += '<h6 class="fw-bold">Itens de Reposicao</h6><ul class="list-group">';
                        reposicaoSim.forEach(item => {
                            content += `<li class="list-group-item d-flex justify-content-between align-items-center">${item.label}<span class="badge bg-success rounded-pill">S</span></li>`;
                        });
                        content += '</ul>';
                    }

                    body.innerHTML = content;
                }

                itensLimpezaModal.show();
            })
            .catch(() => {
                alert('Erro ao carregar dados do registro');
            });
    }

    function toggleCamposTerminalEdit() {
        const tipoLimpeza = document.getElementById('editTipo').value;
        const camposTerminalEdit = document.getElementById('camposTerminalEdit');

        if (tipoLimpeza === '2') {
            camposTerminalEdit.style.display = 'block';
            atualizarContadoresEdicao();
        } else {
            camposTerminalEdit.style.display = 'none';
            if (contadoresEdicao.limpeza) {
                contadoresEdicao.limpeza.style.display = 'none';
            }
            if (contadoresEdicao.reposicao) {
                contadoresEdicao.reposicao.style.display = 'none';
            }
        }
    }

    function abrirModalEdicao(id) {
        currentEditId = id;
        document.getElementById('editRegistroId').textContent = id;

        fetch(`/obter-registro/${id}/`)
            .then(response => response.json())
            .then(data => {
                currentRegistroData = data;
                const camposTerminal = [
                    'portas', 'teto', 'paredes', 'janelas', 'piso',
                    'superficie_mobiliario', 'dispenser',
                    'papel_hig', 'papel_toalha', 'alcool', 'sabonete'
                ];
                camposTerminal.forEach(campo => {
                    currentRegistroData[campo] = (currentRegistroData[campo] || 'NA').toString().toUpperCase();
                });
                document.getElementById('editColaborador').value = data.colaborador || '';
                document.getElementById('editData').value = data.data_limpeza || '';
                document.getElementById('editHora').value = data.hora_limpeza || '';
                const tipoLimpezaValor = data.tipo_limpeza ? data.tipo_limpeza.toString() : '1';
                const criticidadeValor = data.criticidade ? data.criticidade.toString() : '3';
                document.getElementById('editTipo').value = tipoLimpezaValor;
                document.getElementById('editCriticidade').value = criticidadeValor;
                document.getElementById('editObs').value = data.obs || '';
                currentRegistroData.tipo_limpeza = tipoLimpezaValor;
                currentRegistroData.criticidade = criticidadeValor;

                toggleCamposTerminalEdit();
                editModal.show();
            })
            .catch(() => {
                alert('Erro ao carregar dados do registro');
            });
    }

    document.getElementById('editTipo').addEventListener('change', function() {
        if (currentRegistroData) {
            currentRegistroData.tipo_limpeza = this.value;
        }
        toggleCamposTerminalEdit();
    });
    document.getElementById('editCriticidade').addEventListener('change', function() {
        if (currentRegistroData) {
            currentRegistroData.criticidade = this.value;
        }
    });

    document.getElementById('btnSalvarEdit').addEventListener('click', function() {
        if (!currentEditId) return;

        const updates = {
            colaborador: document.getElementById('editColaborador').value.trim(),
            data_limpeza: document.getElementById('editData').value,
            hora_limpeza: document.getElementById('editHora').value,
            tipo_limpeza: document.getElementById('editTipo').value,
            criticidade: document.getElementById('editCriticidade').value,
            portas: currentRegistroData.portas,
            teto: currentRegistroData.teto,
            paredes: currentRegistroData.paredes,
            janelas: currentRegistroData.janelas,
            piso: currentRegistroData.piso,
            superficie_mobiliario: currentRegistroData.superficie_mobiliario,
            dispenser: currentRegistroData.dispenser,
            papel_hig: currentRegistroData.papel_hig,
            papel_toalha: currentRegistroData.papel_toalha,
            alcool: currentRegistroData.alcool,
            sabonete: currentRegistroData.sabonete,
            obs: document.getElementById('editObs').value.trim()
        };

        const updatePromises = Object.entries(updates).map(([field, value]) => {
            return fetch(`/atualizar-registro/${currentEditId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    field: field,
                    value: value || null
                })
            });
        });

        Promise.all(updatePromises)
            .then(responses => {
                const allOk = responses.every(r => r.ok);
                if (allOk) {
                    editModal.hide();
                    location.reload();
                } else {
                    alert('Erro ao salvar algumas alterações');
                }
            })
            .catch(() => {
                alert('Erro de conexão ao salvar');
            });
    });

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    document.getElementById('btnExcluirModal').addEventListener('click', function() {
        if (!currentEditId) return;

        document.getElementById('deleteId').textContent = currentEditId;
        deleteModal.show();
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        const idToDelete = currentEditId;

        fetch(`/excluir-registro/${idToDelete}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                deleteModal.hide();
                editModal.hide();

                const row = document.querySelector(`tr[data-registro-id="${idToDelete}"]`);
                if (row) {
                    row.remove();
                    allRows = Array.from(tableBody.querySelectorAll('tr'));
                    applyFilters();
                }
            } else {
                alert('Erro ao excluir registro');
            }
        }).catch(() => {
            alert('Erro de conexão');
        });
    });
</script>
{% endblock %}
