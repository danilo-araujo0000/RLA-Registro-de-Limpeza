{% extends 'base.html' %}

{% load static %}
{% block title %}Relatório de Limpeza{% endblock %}

{% block style %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/relatorio.css' %}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'salas_view' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="filter-section">
        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <label class="form-label"><i class="fas fa-search"></i> Pesquisar</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Sala, setor, colaborador...">
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label"><i class="fas fa-broom"></i> Tipo</label>
                <select id="tipoFilter" class="form-select">
                    <option value="">Todos</option>
                    <option value="terminal">Terminal</option>
                    <option value="concorrente">Concorrente</option>
                </select>
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label"><i class="fas fa-sort"></i> Ordenar por</label>
                <select id="sortBy" class="form-select">
                    <option value="data_desc">Data (Mais recente)</option>
                    <option value="data_asc">Data (Mais antiga)</option>
                    <option value="sala_asc">Sala (A-Z)</option>
                    <option value="sala_desc">Sala (Z-A)</option>
                </select>
            </div>
        </div>
        <div class="row g-3 mt-2">
            <div class="col-md-3">
                <label class="form-label"><i class="fas fa-calendar"></i> Data Início</label>
                <input type="date" id="dataInicio" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="fas fa-calendar"></i> Data Fim</label>
                <input type="date" id="dataFim" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label d-block"><i class="fas fa-building"></i> Setores</label>
                <div class="border rounded" style="background-color: #fff; position: relative;">
                    <button type="button" class="btn w-100 text-start d-flex justify-content-between align-items-center" id="toggleSetores" style="border: none; background: transparent; padding: 8px 12px;">
                        <span style="font-size: 0.9rem;">Selecionar setores</span>
                        <i class="fas fa-chevron-down" id="chevronSetores" style="font-size: 0.85rem;"></i>
                    </button>
                    <div id="setoresList" class="border-top" style="max-height: 300px; overflow-y: auto; display: none; position: absolute; z-index: 1000; background: white; width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <div class="p-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="setorTodos" data-setor="" data-index="-1" checked>
                                <label class="form-check-label d-flex align-items-center gap-2" for="setorTodos" style="cursor: pointer;">
                                    <span class="setor-badge setor-color-all">
                                        <i class="fas fa-layer-group"></i> Todos
                                    </span>
                                </label>
                            </div>
                            <hr class="my-2">
                            {% for setor in setores %}
                            <div class="form-check mb-2">
                                <input class="form-check-input setor-checkbox" type="checkbox" id="setor{{ setor.id }}" data-setor="{{ setor.nome }}" data-id="{{ setor.id }}" data-color="{{ setor.color }}">
                                <label class="form-check-label d-flex align-items-center gap-2" for="setor{{ setor.id }}" style="cursor: pointer;">
                                    <span class="setor-badge {{ setor.color }}" data-setor="{{ setor.nome }}">
                                        <i class="fas fa-building"></i> {{ setor.nome }}
                                    </span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <input type="hidden" id="setorFilter" value="">
            </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <span id="resultCount" class="text-muted">Total: {{ registros|length }} registros</span>
            <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-redo"></i> Limpar Filtros
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-bordered table-hover table-sm">
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th style="width: 120px;">Setor</th>
                    <th style="width: 200px;">Sala</th>
                    <th style="width: 250px;">Colaborador</th>
                    <th style="width: 100px;">Tipo</th>
                    <th style="width: 120px;">Criticidade</th>
                    <th style="min-width: 150px;">Observações</th>
                    <th style="width: 180px;">Data e Hora</th>
                    <th style="width: 180px;">Ações</th>
                </tr>
            </thead>
                        <tbody id="tableBody">
                {% for registro in registros %}
                <tr data-setor="{{ registro.nome_setor }}" data-tipo="{{ registro.tipo_limpeza }}" data-data="{{ registro.data_limpeza|date:'Y-m-d' }}" data-sala="{{ registro.nome_sala }}" data-registro-id="{{ registro.id_registro }}">
                    <td>{{ registro.id_registro }}</td>
                    <td>
                        <span class="setor-badge {{ registro.setor_color }}" data-setor="{{ registro.nome_setor }}">
                            <i class="fas fa-building"></i> {{ registro.nome_setor }}
                        </span>
                    </td>
                    <td><strong>{{ registro.nome_sala }}</strong></td>
                    <td style="white-space: pre-line;">{{ registro.colaborador }}</td>
                    <td>
                        <span class="badge badge-{{ registro.tipo_limpeza }}">{{ registro.tipo_limpeza|upper }}</span>
                    </td>
                    <td>
                        {% if registro.criticidade and registro.criticidade != 'NA' %}
                            {% with crit_slug=registro.criticidade|slugify %}
                                {% if crit_slug == 'critico' %}
                                    <span class="criticidade-badge criticidade-critico">{{ registro.criticidade }}</span>
                                {% elif crit_slug == 'semi-critico' %}
                                    <span class="criticidade-badge criticidade-semi-critico">{{ registro.criticidade }}</span>
                                {% elif crit_slug == 'nao-critico' %}
                                    <span class="criticidade-badge criticidade-nao-critico">{{ registro.criticidade }}</span>
                                {% else %}
                                    <span class="criticidade-badge criticidade-desconhecida">{{ registro.criticidade }}</span>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ registro.obs }}">
                        {{ registro.obs|default:"-" }}
                    </td>
                    <td>{{ registro.data_limpeza|date:"d/m" }} às {{ registro.hora_limpeza }}</td>
                    <td>
                        <div class="d-flex">
                            <button class="btn btn-info btn-sm" onclick="mostrarItensLimpeza({{ registro.id_registro }})">
                                <i class="fas fa-info-circle"></i> Info
                            </button>
                            <button class="btn btn-secondary btn-sm ms-1" onclick="abrirModalEdicao({{ registro.id_registro }})">
                                <i class="fas fa-pencil-alt"></i> Editar
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center text-muted">Nenhum registro encontrado no último mês.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editar Registro #<span id="editRegistroId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">
                        <i class="fas fa-users"></i> Colaboradores
                        <small class="text-muted"></small>
                    </label>

                    
                    <div id="avisoContainerEdit"></div>

                    
                    <div id="colaboradoresContainerEdit"></div>

                    
                    <div style="position: relative;" id="searchContainerEdit">
                        <input type="text" id="colaboradorSearchEdit" class="form-control" autocomplete="off" placeholder="Selecionar colaborador..." readonly>
                        <ul id="colaboradorListEdit" class="autocomplete-list"></ul>
                    </div>

                    
                    <input type="hidden" id="colaboradoresJsonEdit" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Data</label>
                        <input type="date" id="editData" class="form-control">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Hora</label>
                        <input type="time" id="editHora" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de Limpeza</label>
                        <select id="editTipo" class="form-select">
                            <option value="1">Concorrente</option>
                            <option value="2">Terminal</option>
                        </select>
                    </div>
                </div>

                <div id="camposTerminalEdit" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Criticidade</label>
                            <select id="editCriticidade" class="form-select">
                                <option value="1">Crítico</option>
                                <option value="2">Semi-crítico</option>
                                <option value="3">Não crítico</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary w-100" id="btnAbrirModalEdicaoLimpeza" style="font-size: 16px; padding: 14px;">
                            <i class="fas fa-list-check"></i> Selecionar Itens de Limpeza
                            <span id="contadorItensEdicao" style="display: none; margin-left: 10px; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 700;"></span>
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-success w-100" id="btnAbrirModalEdicaoReposicao" style="font-size: 16px; padding: 14px;">
                        <i class="fas fa-box"></i> REPOSIÇÃO
                        <span id="contadorReposicaoEdicao" style="display: none; margin-left: 10px; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 12px; font-size: 13px; font-weight: 700;"></span>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Observações</label>
                    <textarea id="editObs" class="form-control" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="btnExcluirModal">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarEdit">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o registro <strong>#<span id="deleteId"></span></strong>?</p>
                <p class="text-muted mb-0">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itensLimpezaModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <div>
                    <h5 class="modal-title mb-0">
                        <i class="fas fa-clipboard-list"></i> Detalhes do Registro
                    </h5>
                    <small class="text-white-50">ID #<span id="itensLimpezaRegistroId"></span></small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="itensLimpezaBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div id="modalItensLimpezaEdicao" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Itens de Limpeza Terminal</h3>
            <button type="button" class="btn-close-modal" id="btnFecharModalLimpezaEdicao">&times;</button>
        </div>
        <div class="modal-body">
            <div class="item-limpeza">
                <label class="item-label">Portas</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_portas" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_portas" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Teto</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_teto" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_teto" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Paredes</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_paredes" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_paredes" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Janelas</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_janelas" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_janelas" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Piso</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_piso" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_piso" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Superfície/Mobiliário</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_superficie_mobiliario" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_superficie_mobiliario" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Dispenser</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_dispenser" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_dispenser" value="N"> NÃO
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success w-100" id="btnConfirmarModalLimpezaEdicao" style="font-size: 20px; padding: 18px;">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>

<div id="modalReposicaoEdicao" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Itens de Reposição</h3>
            <button type="button" class="btn-close-modal" id="btnFecharModalReposicaoEdicao">&times;</button>
        </div>
        <div class="modal-body">
            <div class="item-limpeza">
                <label class="item-label">Papel Higiênico</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_hig" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_hig" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Papel Toalha</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_toalha" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_papel_toalha" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Álcool</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_alcool" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_alcool" value="N"> NÃO
                    </label>
                </div>
            </div>
            <div class="item-limpeza">
                <label class="item-label">Sabonete</label>
                <div class="item-opcoes">
                    <label class="radio-label">
                        <input type="radio" name="modal_sabonete" value="S"> SIM
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="modal_sabonete" value="N"> NÃO
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success w-100" id="btnConfirmarModalReposicaoEdicao" style="font-size: 20px; padding: 18px;">
                <i class="fas fa-check"></i> Confirmar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('searchInput');
    const tipoFilter = document.getElementById('tipoFilter');
    const sortBy = document.getElementById('sortBy');
    const dataInicio = document.getElementById('dataInicio');
    const dataFim = document.getElementById('dataFim');
    const clearFilters = document.getElementById('clearFilters');
    const tableBody = document.getElementById('tableBody');
    const resultCount = document.getElementById('resultCount');
    const setorTodos = document.getElementById('setorTodos');
    const setorCheckboxes = Array.from(document.querySelectorAll('.setor-checkbox'));
    const setorBadges = Array.from(document.querySelectorAll('.setor-badge'));
    const setorColors = [
        'setor-color-0', 'setor-color-1', 'setor-color-2', 'setor-color-3',
        'setor-color-4', 'setor-color-5', 'setor-color-6', 'setor-color-7',
        'setor-color-8', 'setor-color-9', 'setor-color-10', 'setor-color-11',
        'setor-color-12', 'setor-color-13', 'setor-color-14', 'setor-color-15'
    ];
    const setorColorMap = {};

    let allRows = Array.from(tableBody.querySelectorAll('tr'));

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('data_inicio')) {
        dataInicio.value = urlParams.get('data_inicio');
    } else {
        const hoje = new Date();
        const trintaDiasAtras = new Date(hoje);
        trintaDiasAtras.setDate(hoje.getDate() - 30);
        dataInicio.value = trintaDiasAtras.toISOString().split('T')[0];
    }
    if (urlParams.get('data_fim')) {
        dataFim.value = urlParams.get('data_fim');
    } else {
        const hoje = new Date();
        dataFim.value = hoje.toISOString().split('T')[0];
    }

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedTipo = tipoFilter.value;

        const selectedSetores = [];
        if (setorTodos.checked) {
            selectedSetores.push('todos');
        } else {
            setorCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSetores.push(checkbox.dataset.setor);
                }
            });
        }

        let visibleCount = 0;

        allRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const setor = row.dataset.setor;
            const tipo = row.dataset.tipo;

            const matchSearch = text.includes(searchTerm);
            const matchSetor = selectedSetores.includes('todos') || selectedSetores.includes(setor);
            const matchTipo = !selectedTipo || tipo === selectedTipo;

            if (matchSearch && matchSetor && matchTipo) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        resultCount.textContent = `Total: ${visibleCount} registros`;
    }

    function sortTable() {
        const sortValue = sortBy.value;

        allRows.sort((a, b) => {
            if (sortValue === 'data_desc') {
                return b.dataset.data.localeCompare(a.dataset.data);
            } else if (sortValue === 'data_asc') {
                return a.dataset.data.localeCompare(b.dataset.data);
            } else if (sortValue === 'sala_asc') {
                return a.dataset.sala.localeCompare(b.dataset.sala);
            } else if (sortValue === 'sala_desc') {
                return b.dataset.sala.localeCompare(a.dataset.sala);
            }
        });

        allRows.forEach(row => tableBody.appendChild(row));
        applyFilters();
    }

    setorCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
                setorTodos.checked = false;
            }
            applyFilters();
        });
    });

    setorTodos.addEventListener('change', () => {
        if (setorTodos.checked) {
            setorCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        applyFilters();
    });

    const toggleSetores = document.getElementById('toggleSetores');
    const setoresList = document.getElementById('setoresList');
    const chevronSetores = document.getElementById('chevronSetores');

    toggleSetores.addEventListener('click', () => {
        if (setoresList.style.display === 'none') {
            setoresList.style.display = 'block';
            chevronSetores.classList.remove('fa-chevron-down');
            chevronSetores.classList.add('fa-chevron-up');
        } else {
            setoresList.style.display = 'none';
            chevronSetores.classList.remove('fa-chevron-up');
            chevronSetores.classList.add('fa-chevron-down');
        }
    });

    searchInput.addEventListener('input', applyFilters);
    tipoFilter.addEventListener('change', applyFilters);
    dataInicio.addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        if (dataInicio.value) {
            params.set('data_inicio', dataInicio.value);
        } else {
            params.delete('data_inicio');
        }
        if (dataFim.value) {
            params.set('data_fim', dataFim.value);
        }
        window.location.search = params.toString();
    });
    dataFim.addEventListener('change', function() {
        const params = new URLSearchParams(window.location.search);
        if (dataFim.value) {
            params.set('data_fim', dataFim.value);
        } else {
            params.delete('data_fim');
        }
        if (dataInicio.value) {
            params.set('data_inicio', dataInicio.value);
        }
        window.location.search = params.toString();
    });
    sortBy.addEventListener('change', sortTable);

    clearFilters.addEventListener('click', () => {
        window.location.href = window.location.pathname;
    });

    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const itensLimpezaModal = new bootstrap.Modal(document.getElementById('itensLimpezaModal'));
    const modalItensLimpezaEdicao = document.getElementById('modalItensLimpezaEdicao');
    const modalReposicaoEdicao = document.getElementById('modalReposicaoEdicao');
    const itensLimpezaKeys = ['portas', 'teto', 'paredes', 'janelas', 'piso', 'superficie_mobiliario', 'dispenser'];
    const itensReposicaoKeys = ['papel_hig', 'papel_toalha', 'alcool', 'sabonete'];
    const modaisEdicao = {
        limpeza: modalItensLimpezaEdicao,
        reposicao: modalReposicaoEdicao
    };
    const itensPorTipo = {
        limpeza: itensLimpezaKeys,
        reposicao: itensReposicaoKeys
    };
    const contadoresEdicao = {
        limpeza: document.getElementById('contadorItensEdicao'),
        reposicao: document.getElementById('contadorReposicaoEdicao')
    };
    let currentEditId = null;
    let currentRegistroData = null;

    
    let colaboradoresSelecionadosEdit = [];
    const MAX_COLABORADORES = 5;
    
    const todosColaboradoresEdit = {{ colaboradores|safe }} || [];

    function mostrarAvisoEdit(mensagem) {
        const avisoContainer = document.getElementById('avisoContainerEdit');
        const aviso = document.createElement('div');
        aviso.className = 'aviso-simples';
        aviso.textContent = mensagem;
        aviso.style.cssText = 'background-color: #fff3cd; color: #856404; border: 2px solid #ffc107; padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; font-weight: 600; text-align: center;';
        avisoContainer.appendChild(aviso);

        setTimeout(() => {
            aviso.remove();
        }, 3000);
    }

    function adicionarColaboradorEdit(colaborador) {
        if (colaboradoresSelecionadosEdit.length >= MAX_COLABORADORES) {
            mostrarAvisoEdit(`Você só pode adicionar até ${MAX_COLABORADORES} colaboradores.`);
            return;
        }

        if (colaboradoresSelecionadosEdit.find(c => c.cd_usuario === colaborador.cd_usuario)) {
            mostrarAvisoEdit('Já adicionado');
            return;
        }

        colaboradoresSelecionadosEdit.push(colaborador);
        renderizarColaboradoresEdit();
        atualizarJSONEdit();

        document.getElementById('colaboradorSearchEdit').value = '';
        document.getElementById('colaboradorListEdit').style.display = 'none';

        if (colaboradoresSelecionadosEdit.length >= MAX_COLABORADORES) {
            document.getElementById('searchContainerEdit').style.display = 'none';
        }
    }

    function removerColaboradorEdit(index) {
        colaboradoresSelecionadosEdit.splice(index, 1);
        renderizarColaboradoresEdit();
        atualizarJSONEdit();

        if (colaboradoresSelecionadosEdit.length < MAX_COLABORADORES) {
            document.getElementById('searchContainerEdit').style.display = 'block';
        }
    }

    function renderizarColaboradoresEdit() {
        const container = document.getElementById('colaboradoresContainerEdit');
        container.innerHTML = '';

        colaboradoresSelecionadosEdit.forEach((colaborador, index) => {
            const card = document.createElement('div');
            card.className = 'colaborador-card';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'colaborador-info';

            const numeroSpan = document.createElement('span');
            numeroSpan.className = 'colaborador-numero';
            numeroSpan.textContent = index + 1;

            const nomeSpan = document.createElement('span');
            nomeSpan.className = 'colaborador-nome';
            nomeSpan.textContent = colaborador.primeiro_nome;

            const cdSpan = document.createElement('span');
            cdSpan.className = 'colaborador-codigo';
            cdSpan.textContent = colaborador.cd_usuario;

            infoDiv.appendChild(numeroSpan);
            infoDiv.appendChild(nomeSpan);
            infoDiv.appendChild(cdSpan);

            const btnRemover = document.createElement('button');
            btnRemover.type = 'button';
            btnRemover.className = 'btn-remover';
            btnRemover.innerHTML = '<i class="fas fa-times"></i> Remover';
            btnRemover.onclick = () => removerColaboradorEdit(index);

            card.appendChild(infoDiv);
            card.appendChild(btnRemover);
            container.appendChild(card);
        });
    }

    function atualizarJSONEdit() {
        const jsonObj = {};
        colaboradoresSelecionadosEdit.forEach((colaborador, index) => {
            jsonObj[index + 1] = colaborador.primeiro_nome;
        });

        document.getElementById('colaboradoresJsonEdit').value = JSON.stringify(jsonObj);
    }

    function filtrarColaboradoresEdit(termo) {
        const resultados = todosColaboradoresEdit.filter(colaborador =>
            colaborador.primeiro_nome.toLowerCase().includes(termo.toLowerCase()) ||
            colaborador.nome_completo.toLowerCase().includes(termo.toLowerCase()) ||
            colaborador.cd_usuario.toString().includes(termo)
        );

        const lista = document.getElementById('colaboradorListEdit');
        lista.innerHTML = '';

        if (resultados.length > 0) {
            resultados.forEach(colaborador => {
                const li = document.createElement('li');
                li.className = 'autocomplete-item';

                const nomeSpan = document.createElement('span');
                nomeSpan.textContent = colaborador.primeiro_nome;

                const cdSpan = document.createElement('span');
                cdSpan.className = 'cd-usuario';
                cdSpan.textContent = colaborador.cd_usuario;

                li.appendChild(nomeSpan);
                li.appendChild(cdSpan);

                li.addEventListener('click', () => adicionarColaboradorEdit(colaborador));

                lista.appendChild(li);
            });
            lista.style.display = 'block';
        } else {
            lista.style.display = 'none';
        }
    }

    const inputColaboradorEdit = document.getElementById('colaboradorSearchEdit');
    inputColaboradorEdit.addEventListener('click', () => {
        filtrarColaboradoresEdit('');
    });
    inputColaboradorEdit.addEventListener('focus', () => {
        filtrarColaboradoresEdit('');
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#colaboradorSearchEdit') && !e.target.closest('#colaboradorListEdit')) {
            document.getElementById('colaboradorListEdit').style.display = 'none';
        }
    });

    function limparMarcacoesModal(modal) {
        if (!modal) return;
        modal.querySelectorAll('.item-limpeza').forEach(item => item.classList.remove('erro', 'completo'));
    }

    function preencherModalEdicao(tipo) {
        if (!currentRegistroData) return;
        const modal = modaisEdicao[tipo];
        if (!modal) return;
        limparMarcacoesModal(modal);
        itensPorTipo[tipo].forEach(chave => {
            const valor = (currentRegistroData[chave] || '').toString().toUpperCase();
            const radios = modal.querySelectorAll(`input[name="modal_${chave}"]`);
            radios.forEach(radio => {
                radio.checked = radio.value === valor;
            });
            if ((valor === 'S' || valor === 'N') && radios.length) {
                const itemDiv = radios[0].closest('.item-limpeza');
                if (itemDiv) {
                    itemDiv.classList.add('completo');
                }
            }
        });
    }

    function abrirModalEdicaoItens(tipo) {
        const modal = modaisEdicao[tipo];
        if (!modal || !currentRegistroData) return;
        preencherModalEdicao(tipo);
        modal.classList.add('show');
    }

    function fecharModalEdicaoItens(tipo) {
        const modal = modaisEdicao[tipo];
        if (!modal) return;
        modal.classList.remove('show');
        limparMarcacoesModal(modal);
    }

    function atualizarContadorEdicao(tipo) {
        const contador = contadoresEdicao[tipo];
        if (!contador || !currentRegistroData) return;
        const itens = itensPorTipo[tipo];
        const preenchidos = itens.every(chave => {
            const valor = (currentRegistroData[chave] || '').toString().toUpperCase();
            return valor === 'S' || valor === 'N';
        });
        if (preenchidos) {
            contador.textContent = `${itens.length}/${itens.length}`;
            contador.style.display = 'inline';
        } else {
            contador.style.display = 'none';
        }
    }

    function confirmarModalEdicaoItens(tipo) {
        if (!currentRegistroData) return;
        const modal = modaisEdicao[tipo];
        if (!modal) return;
        const itens = itensPorTipo[tipo];
        let todosPreenchidos = true;

        itens.forEach(chave => {
            const radios = modal.querySelectorAll(`input[name="modal_${chave}"]`);
            const selecionado = modal.querySelector(`input[name="modal_${chave}"]:checked`);
            const itemDiv = radios.length ? radios[0].closest('.item-limpeza') : null;
            if (itemDiv) {
                itemDiv.classList.remove('erro', 'completo');
            }

            if (selecionado) {
                if (itemDiv) {
                    itemDiv.classList.add('completo');
                }
                currentRegistroData[chave] = selecionado.value;
            } else {
                todosPreenchidos = false;
                if (itemDiv) {
                    itemDiv.classList.add('erro');
                }
            }
        });

        if (!todosPreenchidos) {
            const primeiroErro = modal.querySelector('.item-limpeza.erro');
            if (primeiroErro) {
                primeiroErro.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        atualizarContadorEdicao(tipo);
        fecharModalEdicaoItens(tipo);
    }

    [modalItensLimpezaEdicao, modalReposicaoEdicao].forEach(modal => {
        if (!modal) return;
        modal.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const itemDiv = radio.closest('.item-limpeza');
                if (itemDiv) {
                    itemDiv.classList.remove('erro');
                    itemDiv.classList.add('completo');
                }
            });
        });
    });

    const btnAbrirModalEdicaoLimpeza = document.getElementById('btnAbrirModalEdicaoLimpeza');
    if (btnAbrirModalEdicaoLimpeza) {
        btnAbrirModalEdicaoLimpeza.addEventListener('click', () => abrirModalEdicaoItens('limpeza'));
    }
    const btnAbrirModalEdicaoReposicao = document.getElementById('btnAbrirModalEdicaoReposicao');
    if (btnAbrirModalEdicaoReposicao) {
        btnAbrirModalEdicaoReposicao.addEventListener('click', () => abrirModalEdicaoItens('reposicao'));
    }

    const btnFecharModalLimpezaEdicao = document.getElementById('btnFecharModalLimpezaEdicao');
    if (btnFecharModalLimpezaEdicao) {
        btnFecharModalLimpezaEdicao.addEventListener('click', () => fecharModalEdicaoItens('limpeza'));
    }
    const btnConfirmarModalLimpezaEdicao = document.getElementById('btnConfirmarModalLimpezaEdicao');
    if (btnConfirmarModalLimpezaEdicao) {
        btnConfirmarModalLimpezaEdicao.addEventListener('click', () => confirmarModalEdicaoItens('limpeza'));
    }

    const btnFecharModalReposicaoEdicao = document.getElementById('btnFecharModalReposicaoEdicao');
    if (btnFecharModalReposicaoEdicao) {
        btnFecharModalReposicaoEdicao.addEventListener('click', () => fecharModalEdicaoItens('reposicao'));
    }
    const btnConfirmarModalReposicaoEdicao = document.getElementById('btnConfirmarModalReposicaoEdicao');
    if (btnConfirmarModalReposicaoEdicao) {
        btnConfirmarModalReposicaoEdicao.addEventListener('click', () => confirmarModalEdicaoItens('reposicao'));
    }

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            let handled = false;
            if (modalItensLimpezaEdicao && modalItensLimpezaEdicao.classList.contains('show')) {
                fecharModalEdicaoItens('limpeza');
                handled = true;
            }
            if (modalReposicaoEdicao && modalReposicaoEdicao.classList.contains('show')) {
                fecharModalEdicaoItens('reposicao');
                handled = true;
            }
            if (handled) {
                event.preventDefault();
                event.stopPropagation();
            }
        }
    });

    function atualizarContadoresEdicao() {
        atualizarContadorEdicao('limpeza');
        atualizarContadorEdicao('reposicao');
    }

    function mostrarItensLimpeza(id) {
        document.getElementById('itensLimpezaRegistroId').textContent = id;

        fetch(`/obter-registro/${id}/`)
            .then(response => response.json())
            .then(data => {
                const body = document.getElementById('itensLimpezaBody');

                const escapeHtml = (value) => {
                    if (value === null || value === undefined) {
                        return '-';
                    }
                    return value.toString()
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                };

                const formatDate = (value) => {
                    if (!value) {
                        return '-';
                    }
                    const date = new Date(value);
                    if (!Number.isNaN(date.getTime())) {
                        return date.toLocaleDateString('pt-BR');
                    }
                    const parts = value.toString().split('-');
                    if (parts.length === 3) {
                        return `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }
                    return value.toString();
                };

                const formatHour = (value) => {
                    if (!value) {
                        return '-';
                    }
                    const stringValue = value.toString();
                    if (stringValue.length >= 5) {
                        return stringValue.slice(0, 5);
                    }
                    return stringValue;
                };

                const formatTipoLimpeza = (value) => {
                    const normalized = (value || '').toString().trim().toUpperCase();
                    if (normalized === '1' || normalized === 'CONCORRENTE') {
                        return 'Concorrente';
                    }
                    if (normalized === '2' || normalized === 'TERMINAL') {
                        return 'Terminal';
                    }
                    if (normalized === '3' || normalized === 'APOIO') {
                        return 'Apoio';
                    }
                    return value ? value.toString() : '-';
                };

                const formatCriticidade = (value) => {
                    const normalized = (value || '').toString().trim().toUpperCase();
                    if (normalized === '1' || normalized === 'CRITICO' || normalized === 'CRÍTICO') {
                        return 'Critico';
                    }
                    if (normalized === '2' || normalized === 'SEMI-CRITICO' || normalized === 'SEMI-CRÍTICO' || normalized === 'SEMI CRITICO') {
                        return 'Semi-critico';
                    }
                    if (normalized === '3' || normalized === 'NAO CRITICO' || normalized === 'NAO-CRITICO' || normalized === 'NÃO CRITICO') {
                        return 'Nao critico';
                    }
                    if (normalized === 'NA') {
                        return 'Nao informado';
                    }
                    return value ? value.toString() : '-';
                };

                const renderCard = (label, value, options = {}) => {
                    const content = options.allowHtml ? value : escapeHtml(value);
                    return `
                        <div class="info-card">
                            <span class="info-label">${escapeHtml(label)}</span>
                            <span class="info-value">${content}</span>
                        </div>
                    `;
                };

                let colaboradoresHtml = '<span class="info-placeholder">Nao informado</span>';
                if (data.colaborador) {
                    try {
                        const parsed = typeof data.colaborador === 'string' ? JSON.parse(data.colaborador) : data.colaborador;
                        const nomes = Array.isArray(parsed) ? parsed : Object.values(parsed || {});
                        if (nomes.length) {
                            colaboradoresHtml = `<div class="info-chips">${nomes.map((nome) => `<span class="info-chip"><i class="fas fa-user"></i>${escapeHtml(nome)}</span>`).join('')}</div>`;
                        } else {
                            colaboradoresHtml = '<span class="info-placeholder">Nao informado</span>';
                        }
                    } catch (error) {
                        const texto = data.colaborador.toString().trim();
                        colaboradoresHtml = texto ? escapeHtml(texto) : '<span class="info-placeholder">Nao informado</span>';
                    }
                }

                const resumoHtml = [
                    renderCard('Setor', data.nome_setor || '-'),
                    renderCard('Sala', data.nome_sala || '-'),
                    renderCard('Tipo de limpeza', formatTipoLimpeza(data.tipo_limpeza)),
                    renderCard('Criticidade', formatCriticidade(data.criticidade)),
                    renderCard('Data', formatDate(data.data_limpeza)),
                    renderCard('Hora', formatHour(data.hora_limpeza)),
                    renderCard('Dispositivo', data.device || '-'),
                    renderCard('Colaboradores', colaboradoresHtml, { allowHtml: true })
                ].join('');

                const itensLimpeza = [
                    { label: 'Portas', value: data.portas },
                    { label: 'Teto', value: data.teto },
                    { label: 'Paredes', value: data.paredes },
                    { label: 'Janelas', value: data.janelas },
                    { label: 'Piso', value: data.piso },
                    { label: 'Superficie/Mobiliario', value: data.superficie_mobiliario },
                    { label: 'Dispenser', value: data.dispenser }
                ];
                const itensReposicao = [
                    { label: 'Papel higienico', value: data.papel_hig },
                    { label: 'Papel toalha', value: data.papel_toalha },
                    { label: 'Alcool', value: data.alcool },
                    { label: 'Sabonete', value: data.sabonete }
                ];

                const statusFor = (valor) => {
                    const normalized = (valor || '').toString().trim().toUpperCase();
                    if (normalized === 'S' || normalized === 'SIM') {
                        return { className: 'success', icon: 'fa-check-circle' };
                    }
                    if (normalized === 'N' || normalized === 'NAO' || normalized === 'NÃO') {
                        return { className: 'danger', icon: 'fa-times-circle' };
                    }
                    return { className: 'neutral', icon: 'fa-minus-circle' };
                };

                const renderStatusGrid = (itens) => {
                    return `
                        <div class="info-status-grid">
                            ${itens.map((item) => {
                                const status = statusFor(item.value);
                                return `
                                    <div class="info-status ${status.className}">
                                        <div class="info-status-label">
                                            <span>${escapeHtml(item.label)}</span>
                                        </div>
                                        <span class="info-status-icon"><i class="fas ${status.icon}"></i></span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                };

                const observacaoHtml = data.obs && data.obs.toString().trim()
                    ? escapeHtml(data.obs).replace(/\n/g, '<br>')
                    : '<span class="info-placeholder">Sem observacoes s.</span>';
                const observacaoClass = data.obs && data.obs.toString().trim() ? 'info-observacao' : 'info-observacao empty';

                body.innerHTML = `
                    <div class="info-modal-section">
                        <span class="info-modal-title"><i class="fas fa-clipboard-check"></i> Resumo do Registro</span>
                        <div class="info-grid">
                            ${resumoHtml}
                        </div>
                    </div>
                    <div class="info-modal-section">
                        <span class="info-modal-title"><i class="fas fa-broom"></i> Itens de Limpeza</span>
                        ${renderStatusGrid(itensLimpeza)}
                    </div>
                    <div class="info-modal-section">
                        <span class="info-modal-title"><i class="fas fa-box-open"></i> Itens de Reposicao</span>
                        ${renderStatusGrid(itensReposicao)}
                    </div>
                    <div class="info-modal-section">
                        <span class="info-modal-title"><i class="fas fa-comment-alt"></i> Observacoes</span>
                        <div class="${observacaoClass}">
                            ${observacaoHtml}
                        </div>
                    </div>
                `;

                itensLimpezaModal.show();
            })
            .catch(() => {
                alert('Erro ao carregar dados do registro');
            });
    }
    function toggleCamposTerminalEdit() {
        const tipoLimpeza = document.getElementById('editTipo').value;
        const camposTerminalEdit = document.getElementById('camposTerminalEdit');

        if (tipoLimpeza === '2') {
            camposTerminalEdit.style.display = 'block';
            atualizarContadoresEdicao();
        } else {
            camposTerminalEdit.style.display = 'none';
            if (contadoresEdicao.limpeza) {
                contadoresEdicao.limpeza.style.display = 'none';
            }
            if (contadoresEdicao.reposicao) {
                contadoresEdicao.reposicao.style.display = 'none';
            }
        }
    }

    function abrirModalEdicao(id) {
        currentEditId = id;
        document.getElementById('editRegistroId').textContent = id;

        // Limpar colaboradores anteriores
        colaboradoresSelecionadosEdit = [];
        document.getElementById('colaboradoresContainerEdit').innerHTML = '';
        document.getElementById('searchContainerEdit').style.display = 'block';

        // Garantir que colaboradores estejam carregados
        const carregarPromise = Promise.resolve();

        // Carregar dados do registro
        carregarPromise
            .then(() => fetch(`/obter-registro/${id}/`))
            .then(response => response.json())
            .then(data => {
                currentRegistroData = data;
                const camposTerminal = [
                    'portas', 'teto', 'paredes', 'janelas', 'piso',
                    'superficie_mobiliario', 'dispenser',
                    'papel_hig', 'papel_toalha', 'alcool', 'sabonete'
                ];
                camposTerminal.forEach(campo => {
                    currentRegistroData[campo] = (currentRegistroData[campo] || 'NA').toString().toUpperCase();
                });

                // Processar colaboradores do JSON
                try {
                    const colaboradoresObj = JSON.parse(data.colaborador);
                    Object.values(colaboradoresObj).forEach((nome) => {
                        const colab = todosColaboradoresEdit.find(c => c.primeiro_nome === nome);
                        if (colab && !colaboradoresSelecionadosEdit.find(c => c.cd_usuario === colab.cd_usuario)) {
                            colaboradoresSelecionadosEdit.push(colab);
                        }
                    });
                    renderizarColaboradoresEdit();
                    atualizarJSONEdit();
                } catch (e) {
                    console.log('Erro ao processar colaboradores:', e, data.colaborador);
                }

                document.getElementById('editData').value = data.data_limpeza || '';
                document.getElementById('editHora').value = data.hora_limpeza || '';
                const tipoLimpezaValor = data.tipo_limpeza ? data.tipo_limpeza.toString() : '1';
                const criticidadeValor = data.criticidade ? data.criticidade.toString() : '3';
                document.getElementById('editTipo').value = tipoLimpezaValor;
                document.getElementById('editCriticidade').value = criticidadeValor;
                document.getElementById('editObs').value = data.obs || '';
                currentRegistroData.tipo_limpeza = tipoLimpezaValor;
                currentRegistroData.criticidade = criticidadeValor;

                toggleCamposTerminalEdit();
                editModal.show();
            })
            .catch((error) => {
                console.error('Erro:', error);
                alert('Erro ao carregar dados do registro');
            });
    }

    document.getElementById('editTipo').addEventListener('change', function() {
        if (currentRegistroData) {
            currentRegistroData.tipo_limpeza = this.value;
        }
        toggleCamposTerminalEdit();
    });
    document.getElementById('editCriticidade').addEventListener('change', function() {
        if (currentRegistroData) {
            currentRegistroData.criticidade = this.value;
        }
    });

    document.getElementById('btnSalvarEdit').addEventListener('click', function() {
        if (!currentEditId) return;

        // Validar colaboradores
        const colaboradoresJson = document.getElementById('colaboradoresJsonEdit').value;
        if (!colaboradoresJson || colaboradoresJson.trim() === '' || colaboradoresJson === '{}') {
            mostrarAvisoEdit('Por favor, selecione pelo menos um colaborador');
            return;
        }

        const updates = {
            colaborador: colaboradoresJson,
            data_limpeza: document.getElementById('editData').value,
            hora_limpeza: document.getElementById('editHora').value,
            tipo_limpeza: document.getElementById('editTipo').value,
            criticidade: document.getElementById('editCriticidade').value,
            portas: currentRegistroData.portas,
            teto: currentRegistroData.teto,
            paredes: currentRegistroData.paredes,
            janelas: currentRegistroData.janelas,
            piso: currentRegistroData.piso,
            superficie_mobiliario: currentRegistroData.superficie_mobiliario,
            dispenser: currentRegistroData.dispenser,
            papel_hig: currentRegistroData.papel_hig,
            papel_toalha: currentRegistroData.papel_toalha,
            alcool: currentRegistroData.alcool,
            sabonete: currentRegistroData.sabonete,
            obs: document.getElementById('editObs').value.trim()
        };

        const updatePromises = Object.entries(updates).map(([field, value]) => {
            return fetch(`/atualizar-registro/${currentEditId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    field: field,
                    value: value || null
                })
            });
        });

        Promise.all(updatePromises)
            .then(responses => {
                const allOk = responses.every(r => r.ok);
                if (allOk) {
                    editModal.hide();
                    location.reload();
                } else {
                    alert('Erro ao salvar algumas alterações');
                }
            })
            .catch(() => {
                alert('Erro de conexão ao salvar');
            });
    });

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    document.getElementById('btnExcluirModal').addEventListener('click', function() {
        if (!currentEditId) return;

        document.getElementById('deleteId').textContent = currentEditId;
        deleteModal.show();
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        const idToDelete = currentEditId;

        fetch(`/excluir-registro/${idToDelete}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                deleteModal.hide();
                editModal.hide();

                const row = document.querySelector(`tr[data-registro-id="${idToDelete}"]`);
                if (row) {
                    row.remove();
                    allRows = Array.from(tableBody.querySelectorAll('tr'));
                    applyFilters();
                }
            } else {
                alert('Erro ao excluir registro');
            }
        }).catch(() => {
            alert('Erro de conexão');
        });
    });
</script>
{% endblock %}
