{% extends 'base.html' %}

{% block title %}Histórico de Limpeza{% endblock %}

{% block style %}
.card {
    background-color: #fff;
    padding: 35px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
.registro-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f9f9f9;
}
.registro-item.destaque {
    border: 2px solid #0d6efd;
    background-color: #e7f3ff;
}
.badge-s {
    background-color: #28a745 !important;
    color: white !important;
}
.badge-n {
    background-color: #dc3545 !important;
    color: white !important;
}
.badge-na {
    background-color: #6c757d !important;
    color: white !important;
}
{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Histórico de Limpeza</h2>
        <a href="{% url 'index_view' sala.id_sala %}" class="btn btn-secondary">Voltar</a>
    </div>

    <div class="mb-4">
        <p class="mb-1"><strong>Setor:</strong> {{ sala.nome_setor }}</p>
        <p><strong>Sala:</strong> {{ sala.nome_sala }}</p>
    </div>

    <hr>

    <div id="registros-container">
        {% for registro in registros %}
        <div class="registro-item {% if forloop.first %}destaque{% endif %}">
            {% if forloop.first %}
            <div class="mb-2">
                <span class="badge bg-primary">ÚLTIMO REGISTRO</span>
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6">
                    <p><i class="fas fa-user"></i> <strong>Colaborador:</strong> {{ registro.colaborador }}</p>
                    <p><i class="fas fa-calendar"></i> <strong>Data:</strong> {{ registro.data_limpeza|date:"d/m/Y" }} ({{ registro.data_limpeza|date:"D" }})</p>
                    <p><i class="fas fa-clock"></i> <strong>Hora:</strong> {{ registro.hora_limpeza }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Tipo:</strong>
                        <span class="badge bg-{% if registro.tipo_limpeza == 'terminal' %}warning{% else %}info{% endif %}">
                            {{ registro.tipo_limpeza|upper }}
                        </span>
                    </p>
                    {% if registro.criticidade %}
                    <p><i class="fas fa-exclamation-triangle"></i> <strong>Criticidade:</strong> {{ registro.criticidade }}</p>
                    {% endif %}
                </div>
            </div>

            {% if registro.tipo_limpeza == 'terminal' %}
            <div class="mt-3">
                <strong>Itens Limpos:</strong>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    {% if registro.portas != 'NA' %}<span class="badge badge-{{ registro.portas|lower }}">Portas: {{ registro.portas }}</span>{% endif %}
                    {% if registro.teto != 'NA' %}<span class="badge badge-{{ registro.teto|lower }}">Teto: {{ registro.teto }}</span>{% endif %}
                    {% if registro.paredes != 'NA' %}<span class="badge badge-{{ registro.paredes|lower }}">Paredes: {{ registro.paredes }}</span>{% endif %}
                    {% if registro.janelas != 'NA' %}<span class="badge badge-{{ registro.janelas|lower }}">Janelas: {{ registro.janelas }}</span>{% endif %}
                    {% if registro.piso != 'NA' %}<span class="badge badge-{{ registro.piso|lower }}">Piso: {{ registro.piso }}</span>{% endif %}
                    {% if registro.superficie_mobiliario != 'NA' %}<span class="badge badge-{{ registro.superficie_mobiliario|lower }}">Superfície: {{ registro.superficie_mobiliario }}</span>{% endif %}
                    {% if registro.dispenser != 'NA' %}<span class="badge badge-{{ registro.dispenser|lower }}">Dispenser: {{ registro.dispenser }}</span>{% endif %}
                </div>
            </div>
            {% endif %}

            {% if registro.obs %}
            <div class="mt-3">
                <strong>Observações:</strong>
                <p class="mb-0">{{ registro.obs }}</p>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <p class="text-center text-muted">Nenhum registro encontrado para esta sala.</p>
        {% endfor %}
    </div>

    {% if has_more %}
    <div class="text-center mt-3">
        <button id="btn-mostrar-mais" class="btn btn-primary" onclick="carregarMais()">Mostrar Mais</button>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let offset = {{ offset }};
    const salaId = {{ sala.id_sala }};

    async function carregarMais() {
        const btn = document.getElementById('btn-mostrar-mais');
        btn.disabled = true;
        btn.textContent = 'Carregando...';

        try {
            const response = await fetch(`/historico/${salaId}/?offset=${offset}&ajax=1`);
            const data = await response.json();

            if (data.registros && data.registros.length > 0) {
                const container = document.getElementById('registros-container');
                container.innerHTML += data.html;
                offset += data.registros.length;

                if (!data.has_more) {
                    btn.remove();
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Mostrar Mais';
                }
            } else {
                btn.remove();
            }
        } catch (error) {
            console.error('Erro ao carregar mais registros:', error);
            btn.disabled = false;
            btn.textContent = 'Erro - Tentar Novamente';
        }
    }
</script>
{% endblock %}
