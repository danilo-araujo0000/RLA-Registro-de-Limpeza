{% extends 'base.html' %}

{% load static %}
{% block title %}Lista de Salas{% endblock %}

{% block style %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/salas.css' %}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Lista de Salas</h2>
        <a href="javascript:history.back()" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="search-box position-relative">
                <span class="position-absolute top-50 start-0 translate-middle-y ms-3">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="searchInput" class="form-control form-control-lg" style="padding-left: 2.5rem;" placeholder="Pesquisar por sala...">
                <span id="clearSearch" class="position-absolute top-50 end-0 translate-middle-y me-3" style="cursor: pointer; display: none;">
                    <i class="fas fa-times"></i>
                </span>
            </div>
        </div>
        <div class="col-lg-6 d-flex align-items-center">
            <div class="filter-container" id="setorFilters">
                <button type="button" class="filter-badge setor-color-all active" data-setor="">
                    <i class="fas fa-layer-group"></i> Todos os Setores
                </button>
                {% for setor in setores %}
                <button type="button" class="filter-badge {{ setor.color }}" data-setor="{{ setor.slug }}">
                    <i class="fas fa-building"></i> {{ setor.nome }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="salas-container">
        {% for sala in salas %}
        <div class="sala-item" data-setor="{{ sala.setor_slug }}" onclick="window.location.href='{% url 'index_view' sala.id_sala %}'">
            <div class="sala-content">
                <div class="sala-info">
                    <h5 class="mb-1">
                        <i class="fas fa-door-open"></i> {{ sala.nome_sala }}
                    </h5>
                    <span class="badge badge-setor {{ sala.setor_color }}">
                        <i class="fas fa-building"></i> {{ sala.nome_setor }}
                    </span>
                </div>
                <div class="sala-meta">
                    <span class="sala-meta-chip">
                        <span class="meta-text">
                            <strong>Concorrente</strong>
                            <span>
                                {{ sala.ultima_concorrente }}
                                {% if sala.ultima_concorrente_hora %}
                                    &nbsp;{{ sala.ultima_concorrente_hora }}
                                {% endif %}
                            </span>
                        </span>
                    </span>
                    <span class="sala-meta-chip meta-terminal">
                        <span class="meta-text">
                            <strong>Terminal</strong>
                            <span>
                                {{ sala.ultima_terminal_data }}
                                {% if sala.ultima_terminal_hora %}
                                    &nbsp;{{ sala.ultima_terminal_hora }}
                                {% endif %}
                            </span>
                        </span>
                    </span>
                </div>
                <div class="sala-chevron">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-center text-muted">Nenhuma sala encontrada.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const searchInput = document.getElementById('searchInput');
    const salasContainer = document.getElementById('salas-container');
    const salaItems = salasContainer.querySelectorAll('.sala-item');
    const clearSearch = document.getElementById('clearSearch');
    const setorFilters = document.getElementById('setorFilters');
    const filterButtons = setorFilters ? Array.from(setorFilters.querySelectorAll('.filter-badge')) : [];
    const allButton = filterButtons.find(btn => btn.dataset.setor === '');
    const setorSelecionados = new Set();

    function aplicarFiltros() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        if (clearSearch) {
            clearSearch.style.display = searchTerm ? 'block' : 'none';
        }

        salaItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            const setor = item.getAttribute('data-setor');
            const matchTexto = !searchTerm || text.includes(searchTerm);
            const matchSetor = setorSelecionados.size === 0 || setorSelecionados.has(setor);

            if (matchTexto && matchSetor) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', aplicarFiltros);
    }

    if (clearSearch) {
        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            aplicarFiltros();
        });
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const slug = button.dataset.setor || '';

            if (slug === '') {
                setorSelecionados.clear();
                filterButtons.forEach(btn => {
                    if (btn === allButton) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                aplicarFiltros();
                return;
            }

            if (button.classList.contains('active')) {
                button.classList.remove('active');
                setorSelecionados.delete(slug);
            } else {
                button.classList.add('active');
                setorSelecionados.add(slug);
            }

            if (allButton) {
                if (setorSelecionados.size === 0) {
                    allButton.classList.add('active');
                } else {
                    allButton.classList.remove('active');
                }
            }

            aplicarFiltros();
        });
    });

    aplicarFiltros();
</script>
{% endblock %}
